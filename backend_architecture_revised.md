# Backend Architecture - Infertility Treatment Management System

## Tổng quan Kiến trúc

Backend được thiết kế theo **4-Layer Architecture** với separate projects và **Code-First approach** phù hợp cho scope 7 tuần.

```
InfertilityTreatment.sln
│
├── InfertilityTreatment.API/          --> Presentation Layer (Controllers, Middleware)
├── InfertilityTreatment.Business/     --> Business Logic Layer (Services, Interfaces)  
├── InfertilityTreatment.Data/         --> Data Access Layer (Repositories, DbContext)
└── InfertilityTreatment.Entity/       --> Entity Layer (Models, DTOs, Enums)
```

**Dependencies:**
```
API depends on → Business + Entity
Business depends on → Data + Entity  
Data depends on → Entity
Entity → No dependencies
```

---

## 1. InfertilityTreatment.Entity (Entity Layer)

### 1.1 Cấu trúc Project
```
InfertilityTreatment.Entity/
├── Entities/
│   ├── User.cs
│   ├── Customer.cs
│   ├── Doctor.cs
│   ├── RefreshToken.cs
│   ├── TreatmentService.cs
│   ├── TreatmentPackage.cs
│   ├── TreatmentCycle.cs
│   ├── TreatmentPhase.cs
│   ├── Appointment.cs
│   ├── TestResult.cs
│   ├── Medication.cs
│   ├── Prescription.cs
│   ├── Review.cs
│   ├── BlogPost.cs
│   └── Notification.cs
├── DTOs/
│   ├── Auth/
│   │   ├── LoginRequestDto.cs
│   │   ├── RegisterRequestDto.cs
│   │   ├── LoginResponseDto.cs
│   │   └── RefreshTokenRequestDto.cs
│   ├── Users/
│   │   ├── UserProfileDto.cs
│   │   └── CustomerProfileDto.cs
│   ├── TreatmentCycles/
│   │   ├── CreateCycleDto.cs
│   │   ├── UpdateCycleDto.cs
│   │   └── CycleResponseDto.cs
│   └── Common/
│       ├── PaginatedResultDto.cs
│       └── ApiResponseDto.cs
├── Enums/
│   ├── UserRole.cs
│   ├── Gender.cs
│   ├── CycleStatus.cs
│   ├── AppointmentStatus.cs
│   └── NotificationType.cs
└── Common/
    ├── BaseEntity.cs
    └── IAuditableEntity.cs
```

### 1.2 Package Dependencies
```xml
<PackageReference Include="System.ComponentModel.Annotations" Version="5.0.0" />
```

### 1.3 Base Entity
```csharp
public abstract class BaseEntity
{
    public int Id { get; set; }
    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
    public DateTime? UpdatedAt { get; set; }
    public bool IsActive { get; set; } = true;
}

public enum UserRole : byte
{
    Customer = 1,
    Doctor = 2,
    Manager = 3,
    Admin = 4
}
```

---

## 2. InfertilityTreatment.Data (Data Access Layer)

### 2.1 Cấu trúc Project
```
InfertilityTreatment.Data/
├── Context/
│   └── ApplicationDbContext.cs
├── Configurations/
│   ├── UserConfiguration.cs
│   ├── CustomerConfiguration.cs
│   ├── DoctorConfiguration.cs
│   ├── RefreshTokenConfiguration.cs
│   ├── TreatmentCycleConfiguration.cs
│   └── AppointmentConfiguration.cs
├── Repositories/
│   ├── Interfaces/
│   │   ├── IBaseRepository.cs
│   │   ├── IUserRepository.cs
│   │   ├── ICustomerRepository.cs
│   │   ├── ITreatmentCycleRepository.cs
│   │   └── IUnitOfWork.cs
│   └── Implementations/
│       ├── BaseRepository.cs
│       ├── UserRepository.cs
│       ├── CustomerRepository.cs
│       ├── TreatmentCycleRepository.cs
│       └── UnitOfWork.cs
├── Migrations/
│   └── [Auto-generated by EF Core]
└── Seeders/
    ├── UserSeeder.cs
    └── DataSeeder.cs
```

### 2.2 Package Dependencies
```xml
<PackageReference Include="Microsoft.EntityFrameworkCore.SqlServer" Version="8.0.0" />
<PackageReference Include="Microsoft.EntityFrameworkCore.Tools" Version="8.0.0" />
<PackageReference Include="Microsoft.EntityFrameworkCore.Design" Version="8.0.0" />

<ProjectReference Include="..\InfertilityTreatment.Entity\InfertilityTreatment.Entity.csproj" />
```

### 2.3 ApplicationDbContext (Code-First)
```csharp
public class ApplicationDbContext : DbContext
{
    public ApplicationDbContext(DbContextOptions<ApplicationDbContext> options) : base(options) { }

    // DbSets
    public DbSet<User> Users { get; set; }
    public DbSet<Customer> Customers { get; set; }
    public DbSet<Doctor> Doctors { get; set; }
    public DbSet<RefreshToken> RefreshTokens { get; set; }
    public DbSet<TreatmentCycle> TreatmentCycles { get; set; }
    public DbSet<Appointment> Appointments { get; set; }

    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
        // Apply all entity configurations
        modelBuilder.ApplyConfigurationsFromAssembly(typeof(ApplicationDbContext).Assembly);
        
        base.OnModelCreating(modelBuilder);
    }

    public override async Task<int> SaveChangesAsync(CancellationToken cancellationToken = default)
    {
        var entries = ChangeTracker.Entries<BaseEntity>();
        
        foreach (var entry in entries)
        {
            if (entry.State == EntityState.Modified)
            {
                entry.Entity.UpdatedAt = DateTime.UtcNow;
            }
        }

        return await base.SaveChangesAsync(cancellationToken);
    }
}
```

### 2.4 Entity Configuration Example
```csharp
public class UserConfiguration : IEntityTypeConfiguration<User>
{
    public void Configure(EntityTypeBuilder<User> builder)
    {
        builder.HasKey(x => x.Id);
        
        builder.Property(x => x.Email)
               .IsRequired()
               .HasMaxLength(255);
               
        builder.HasIndex(x => x.Email).IsUnique();
        
        builder.Property(x => x.FullName)
               .IsRequired()
               .HasMaxLength(200);
        
        builder.Property(x => x.Role)
               .HasConversion<byte>();

        // One-to-One relationships
        builder.HasOne(x => x.Customer)
               .WithOne(x => x.User)
               .HasForeignKey<Customer>(x => x.UserId)
               .OnDelete(DeleteBehavior.Cascade);

        builder.HasOne(x => x.Doctor)
               .WithOne(x => x.User)
               .HasForeignKey<Doctor>(x => x.UserId)
               .OnDelete(DeleteBehavior.Cascade);

        // One-to-Many relationships  
        builder.HasMany(x => x.RefreshTokens)
               .WithOne(x => x.User)
               .HasForeignKey(x => x.UserId)
               .OnDelete(DeleteBehavior.Cascade);
    }
}
```

### 2.5 Repository Pattern
```csharp
public interface IBaseRepository<T> where T : BaseEntity
{
    Task<T> GetByIdAsync(int id);
    Task<IEnumerable<T>> GetAllAsync();
    Task<IEnumerable<T>> FindAsync(Expression<Func<T, bool>> predicate);
    Task<T> AddAsync(T entity);
    Task UpdateAsync(T entity);
    Task DeleteAsync(int id);
    Task<bool> ExistsAsync(int id);
    Task<int> CountAsync();
}

public interface IUnitOfWork : IDisposable
{
    IUserRepository Users { get; }
    ICustomerRepository Customers { get; }
    ITreatmentCycleRepository TreatmentCycles { get; }
    
    Task<int> SaveChangesAsync();
    Task BeginTransactionAsync();
    Task CommitTransactionAsync();
    Task RollbackTransactionAsync();
}
```

---

## 3. InfertilityTreatment.Business (Business Logic Layer)

### 3.1 Cấu trúc Project
```
InfertilityTreatment.Business/
├── Interfaces/
│   ├── IAuthService.cs
│   ├── IUserService.cs
│   ├── ICustomerService.cs
│   ├── ITreatmentService.cs
│   ├── IAppointmentService.cs
│   └── INotificationService.cs
├── Services/
│   ├── AuthService.cs
│   ├── UserService.cs
│   ├── CustomerService.cs
│   ├── TreatmentService.cs
│   ├── AppointmentService.cs
│   └── NotificationService.cs
├── Validators/
│   ├── LoginRequestValidator.cs
│   ├── RegisterRequestValidator.cs
│   └── CreateCycleValidator.cs
├── Helpers/
│   ├── JwtHelper.cs
│   ├── PasswordHelper.cs
│   └── EmailHelper.cs
└── Mappings/
    └── AutoMapperProfile.cs
```

### 3.2 Package Dependencies
```xml
<PackageReference Include="FluentValidation" Version="11.8.0" />
<PackageReference Include="BCrypt.Net-Next" Version="4.0.3" />
<PackageReference Include="AutoMapper" Version="12.0.1" />
<PackageReference Include="System.IdentityModel.Tokens.Jwt" Version="7.0.0" />

<ProjectReference Include="..\InfertilityTreatment.Data\InfertilityTreatment.Data.csproj" />
<ProjectReference Include="..\InfertilityTreatment.Entity\InfertilityTreatment.Entity.csproj" />
```

### 3.3 Service Example
```csharp
public interface IAuthService
{
    Task<LoginResponseDto> LoginAsync(LoginRequestDto request);
    Task<RegisterResponseDto> RegisterAsync(RegisterRequestDto request);
    Task<LoginResponseDto> RefreshTokenAsync(RefreshTokenRequestDto request);
    Task LogoutAsync(int userId);
}

public class AuthService : IAuthService
{
    private readonly IUnitOfWork _unitOfWork;
    private readonly IMapper _mapper;
    private readonly JwtHelper _jwtHelper;

    public AuthService(IUnitOfWork unitOfWork, IMapper mapper, JwtHelper jwtHelper)
    {
        _unitOfWork = unitOfWork;
        _mapper = mapper;
        _jwtHelper = jwtHelper;
    }

    public async Task<LoginResponseDto> LoginAsync(LoginRequestDto request)
    {
        var user = await _unitOfWork.Users.FindByEmailAsync(request.Email);
        
        if (user == null || !BCrypt.Net.BCrypt.Verify(request.Password, user.PasswordHash))
        {
            throw new UnauthorizedAccessException("Invalid email or password");
        }

        var accessToken = _jwtHelper.GenerateAccessToken(user);
        var refreshToken = await _jwtHelper.GenerateRefreshTokenAsync(user.Id);

        return new LoginResponseDto
        {
            AccessToken = accessToken,
            RefreshToken = refreshToken,
            User = _mapper.Map<UserProfileDto>(user)
        };
    }
}
```

---

## 4. InfertilityTreatment.API (Presentation Layer)

### 4.1 Cấu trúc Project
```
InfertilityTreatment.API/
├── Controllers/
│   ├── AuthController.cs
│   ├── UsersController.cs
│   ├── CustomersController.cs
│   ├── TreatmentCyclesController.cs
│   ├── AppointmentsController.cs
│   └── DashboardController.cs
├── Middleware/
│   ├── ExceptionHandlingMiddleware.cs
│   └── LoggingMiddleware.cs
├── Extensions/
│   ├── ServiceCollectionExtensions.cs
│   └── ApplicationBuilderExtensions.cs
├── Filters/
│   └── ValidationFilter.cs
├── Program.cs
├── appsettings.json
├── appsettings.Development.json
└── appsettings.Production.json
```

### 4.2 Package Dependencies
```xml
<PackageReference Include="Microsoft.AspNetCore.Authentication.JwtBearer" Version="8.0.0" />
<PackageReference Include="Swashbuckle.AspNetCore" Version="6.5.0" />
<PackageReference Include="Serilog.AspNetCore" Version="7.0.0" />
<PackageReference Include="FluentValidation.AspNetCore" Version="11.3.0" />

<ProjectReference Include="..\InfertilityTreatment.Business\InfertilityTreatment.Business.csproj" />
<ProjectReference Include="..\InfertilityTreatment.Entity\InfertilityTreatment.Entity.csproj" />
```

### 4.3 Program.cs Setup
```csharp
var builder = WebApplication.CreateBuilder(args);

// Add services to the container
builder.Services.AddControllers();
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen();

// Database
builder.Services.AddDbContext<ApplicationDbContext>(options =>
    options.UseSqlServer(builder.Configuration.GetConnectionString("DefaultConnection")));

// Authentication & Authorization
builder.Services.AddJwtAuthentication(builder.Configuration);

// Business Services
builder.Services.AddBusinessServices();

// CORS
builder.Services.AddCors(options =>
{
    options.AddPolicy("AllowReactApp", policy =>
    {
        policy.WithOrigins("http://localhost:5173")
              .AllowAnyMethod()
              .AllowAnyHeader()
              .AllowCredentials();
    });
});

var app = builder.Build();

// Configure the HTTP request pipeline
if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI();
}

app.UseHttpsRedirection();
app.UseCors("AllowReactApp");

app.UseAuthentication();
app.UseAuthorization();

app.MapControllers();

app.Run();
```

### 4.4 Controller Example
```csharp
[ApiController]
[Route("api/[controller]")]
public class AuthController : ControllerBase
{
    private readonly IAuthService _authService;

    public AuthController(IAuthService authService)
    {
        _authService = authService;
    }

    [HttpPost("login")]
    public async Task<IActionResult> Login([FromBody] LoginRequestDto request)
    {
        var result = await _authService.LoginAsync(request);
        return Ok(new ApiResponseDto<LoginResponseDto>
        {
            Success = true,
            Data = result,
            Message = "Login successful"
        });
    }

    [HttpPost("register")]
    public async Task<IActionResult> Register([FromBody] RegisterRequestDto request)
    {
        var result = await _authService.RegisterAsync(request);
        return Ok(new ApiResponseDto<RegisterResponseDto>
        {
            Success = true,
            Data = result,
            Message = "Registration successful"
        });
    }

    [HttpPost("refresh")]
    public async Task<IActionResult> RefreshToken([FromBody] RefreshTokenRequestDto request)
    {
        var result = await _authService.RefreshTokenAsync(request);
        return Ok(new ApiResponseDto<LoginResponseDto>
        {
            Success = true,
            Data = result,
            Message = "Token refreshed successfully"
        });
    }
}
```

---

## 5. Configuration & Dependency Injection

### 5.1 Service Extensions
```csharp
public static class ServiceCollectionExtensions
{
    public static IServiceCollection AddBusinessServices(this IServiceCollection services)
    {
        // Repository Pattern
        services.AddScoped<IUnitOfWork, UnitOfWork>();
        services.AddScoped(typeof(IBaseRepository<>), typeof(BaseRepository<>));
        services.AddScoped<IUserRepository, UserRepository>();
        services.AddScoped<ICustomerRepository, CustomerRepository>();

        // Business Services
        services.AddScoped<IAuthService, AuthService>();
        services.AddScoped<IUserService, UserService>();
        services.AddScoped<ITreatmentService, TreatmentService>();

        // Helpers
        services.AddScoped<JwtHelper>();
        services.AddScoped<PasswordHelper>();
        services.AddScoped<EmailHelper>();

        // AutoMapper
        services.AddAutoMapper(typeof(AutoMapperProfile));

        // FluentValidation
        services.AddValidatorsFromAssemblyContaining<LoginRequestValidator>();

        return services;
    }

    public static IServiceCollection AddJwtAuthentication(this IServiceCollection services, IConfiguration configuration)
    {
        var jwtSettings = configuration.GetSection("JwtSettings");
        
        services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)
            .AddJwtBearer(options =>
            {
                options.TokenValidationParameters = new TokenValidationParameters
                {
                    ValidateIssuer = true,
                    ValidateAudience = true,
                    ValidateLifetime = true,
                    ValidateIssuerSigningKey = true,
                    ValidIssuer = jwtSettings["Issuer"],
                    ValidAudience = jwtSettings["Audience"],
                    IssuerSigningKey = new SymmetricSecurityKey(
                        Encoding.UTF8.GetBytes(jwtSettings["SecretKey"])),
                    ClockSkew = TimeSpan.Zero
                };
            });

        services.AddAuthorization(options =>
        {
            options.AddPolicy("CustomerOnly", policy => policy.RequireRole("Customer"));
            options.AddPolicy("DoctorOnly", policy => policy.RequireRole("Doctor"));
            options.AddPolicy("AdminOnly", policy => policy.RequireRole("Admin", "Manager"));
        });

        return services;
    }
}
```

### 5.2 Configuration Files
**appsettings.json:**
```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Server=.;Database=InfertilityTreatmentDB;Trusted_Connection=true;TrustServerCertificate=true;"
  },
  "JwtSettings": {
    "SecretKey": "your-256-bit-secret-key-here-must-be-very-long",
    "Issuer": "InfertilityTreatmentAPI",
    "Audience": "InfertilityTreatmentClient",
    "AccessTokenExpiryMinutes": 60,
    "RefreshTokenExpiryDays": 7
  },
  "EmailSettings": {
    "SmtpHost": "smtp.gmail.com",
    "SmtpPort": 587,
    "FromEmail": "noreply@infertilitytreatment.com",
    "FromName": "Infertility Treatment System"
  },
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  }
}
```

---

## 6. Database Migration Commands

### 6.1 Entity Framework Commands
```bash
# Set Data project as startup for migrations
cd InfertilityTreatment.Data

# Add initial migration
dotnet ef migrations add InitialCreate --startup-project ../InfertilityTreatment.API

# Update database
dotnet ef database update --startup-project ../InfertilityTreatment.API

# Add new migration after model changes
dotnet ef migrations add AddRefreshTokenTable --startup-project ../InfertilityTreatment.API

# Remove last migration
dotnet ef migrations remove --startup-project ../InfertilityTreatment.API

# Generate SQL script
dotnet ef migrations script --startup-project ../InfertilityTreatment.API
```

### 6.2 Migration Best Practices
```csharp
// Always backup database before migration in production
// Use explicit migration names that describe the change
// Review generated migration code before applying
// Test migrations on staging environment first
```

---

## 7. Development Workflow

### 7.1 Project Build Order
```bash
# Build solution in dependency order
dotnet build InfertilityTreatment.Entity
dotnet build InfertilityTreatment.Data  
dotnet build InfertilityTreatment.Business
dotnet build InfertilityTreatment.API

# Or build entire solution
dotnet build InfertilityTreatment.sln
```

### 7.2 Development Guidelines

**Entity Layer:**
- Define all entities with proper relationships
- Keep DTOs separate from entities
- Use enums for status fields
- Implement proper validation attributes

**Data Layer:**
- Configure entities using Fluent API
- Implement repository pattern correctly
- Use Unit of Work for transactions
- Create meaningful seed data

**Business Layer:**
- Keep business logic separate from data access
- Use dependency injection properly
- Implement proper error handling
- Add comprehensive validation

**API Layer:**
- Follow RESTful conventions
- Use proper HTTP status codes
- Implement global error handling
- Add comprehensive logging

---

## 8. Implementation Phases

### Phase 1 (Tuần 1-3): Foundation
```
✅ Create 4-layer project structure
✅ Setup Entity models with relationships
✅ Configure DbContext with Code-First
✅ Implement Repository pattern + UoW
✅ Basic JWT authentication
✅ User registration/login APIs
```

### Phase 2 (Tuần 4-5): Core Features  
```
✅ Treatment cycle management
✅ Appointment scheduling system
✅ Doctor assignment logic
✅ Basic notification system
✅ Test results tracking
```

### Phase 3 (Tuần 6-7): Advanced Features
```
✅ Prescription management
✅ Review and rating system  
✅ Blog management system
✅ Dashboard and analytics
✅ Performance optimization
✅ Production deployment
```

Kiến trúc này đảm bảo:
- ✅ **Clean Architecture** với tách biệt rõ ràng các layer
- ✅ **Code-First** approach với EF Core migrations
- ✅ **Dependency Injection** pattern throughout
- ✅ **Repository + Unit of Work** pattern cho data access
- ✅ **JWT Authentication** với RefreshToken security
- ✅ **Scalable** và maintainable structure